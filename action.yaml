name: GitHub Pages Release action
description: Release GitHub Pages
author: Shunsuke Suzuki
branding:
  icon: git-commit
  color: blue
inputs:
  github_token:
    description: |
      GitHub Access Token
      contents:write - Push commits
    required: false
  app_id:
    description: |
      GitHub App ID
    required: false
  app_private_key:
    description: |
      GitHub App Private Key
    required: false
  publish_branch:
    description: 'Set a target branch for deployment.'
    required: false
    default: gh-pages
  publish_dir:
    description: 'Set an input directory for deployment.'
    required: false
    default: 'public'
  destination_dir:
    description: 'Set an destination subdirectory for deployment.'
    required: false
    default: ''
  external_repository:
    description: 'Set an external repository (owner/repo).'
    required: false
  cname:
    description: 'Set custom domain'
    required: false

  securefix_action_server_repository:
    required: false
    default: ''
    description: |
      The GitHub repository for the Securefix Action server.
      https://github.com/csm-actions/securefix-action
runs:
  using: composite
  steps:
    - shell: bash
      id: repo_name
      run: |
        repo=${REPOSITORY:-$GITHUB_REPOSITORY}
        echo "value=${repo#*/}" >> "$GITHUB_OUTPUT"
        echo "full_name=$repo" >> "$GITHUB_OUTPUT"
      env:
        REPOSITORY: ${{ inputs.external_repository }}

    - shell: bash
      id: dir
      run: echo "value=.gh-pages-action-$GITHUB_RUN_ID" >> "$GITHUB_OUTPUT"

    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        repository: ${{ inputs.external_repository }}
        ref: ${{ inputs.publish_branch }}
        persist-credentials: false
        path: ${{ steps.dir.outputs.value }}
        sparse-checkout: |
          ${{ inputs.destination_dir }}

    - shell: bash
      id: files
      env:
        SOURCE: ${{ inputs.publish_dir }}
        DEST: ${{ inputs.destination_dir }}
        DIR: ${{ steps.dir.outputs.value }}
        CNAME: ${{ inputs.cname }}
      run: |
        rm -Rf "$DIR/$DEST"
        cp -R "$SOURCE" "$DIR/$DEST"
        cd "$DIR"

        touch "${DEST:-.}/.nojekyll"

        if [ -n "$CNAME" ]; then
          echo "$CNAME" > "$DEST/CNAME"
        fi
        echo "files<<EOF"
        git ls-files --modified --others --exclude-standard "${DEST:-.}"
        echo "EOF"

    # Commit changes
    - uses: suzuki-shunsuke/commit-action@b4aee3f297a855b761e0db5736a73566a7807fe2 # v0.0.11
      if: inputs.securefix_action_server_repository == ''
      with:
        github_token: ${{ inputs.github_token }}
        app_id: ${{ inputs.app_id }}
        app_private_key: ${{ inputs.app_private_key }}
        repository: ${{ inputs.external_repository }}
        branch: ${{ inputs.publish_branch }}
        files: ${{ steps.files.outputs.files }}
        root_dir: ${{ steps.dir.outputs.value }}
        commit_message: |
          deploy: ${{ github.repository }}@${{ github.sha }}
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - uses: csm-actions/securefix-action@f2592f3d2f3e17ef629f1d2f02ae79d04a2579e9 # v0.3.3
      if: inputs.securefix_action_server_repository != ''
      with:
        app_id: ${{ inputs.app_id }}
        app_private_key: ${{ inputs.app_private_key }}
        repository: ${{ inputs.external_repository }}
        branch: ${{ inputs.publish_branch }}
        files: ${{ steps.files.outputs.files }}
        root_dir: ${{ steps.dir.outputs.value }}
        server_repository: ${{ inputs.securefix_action_server_repository }}
        commit_message: |
          deploy: ${{ github.repository }}@${{ github.sha }}
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - shell: bash
      env:
        DIR: ${{ steps.dir.outputs.value }}
      run: |
        rm -Rf "$DIR"
